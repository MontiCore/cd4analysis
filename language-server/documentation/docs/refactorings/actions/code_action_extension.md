# Design and Extension of CodeActions

## Registering CodeActions

The `CD4AnalysisCodeActionProvider` class provides code actions for the CD4Analysis language.
The class extends the LSP code action provider from MontiCore and adds code actions for the CD4Analysis language.
These code actions are implemented using different strategies for the `CodeActionStrategy` interface.

The constructor of the `CD4AnalysisCodeActionProvider` takes two parameters: a `DocumentManager` and an `AstPrettyPrinter<ASTCDCompilationUnit>`.
The `DocumentManager` is an object that keeps track of the documents opened in the editor and their corresponding ASTs.
The ASTs are abstract syntax trees representing the structure and semantics of the CD4Analysis models.
The `AstPrettyPrinter<ASTCDCompilationUnit>` is an object that can pretty print an AST back to a CD4Analysis model as a string.

The constructor also creates an empty list of `CodeActionStrategy` objects, which are used to store the different kinds of code actions.

### The `codeAction` Method 

The main method of this class is the `codeAction` method, which overrides the method from the superclass.
This method is called by the LSP server when a code action request is received from the editor.
The method takes three parameters: a `TextDocumentItem`, a `CodeActionContext`, and a `Range`.

* The `TextDocumentItem` represents the document on which the code action is requested.
* The `CodeActionContext` contains information about the context of the request, such as the diagnostics or the kind of code action.
* The `Range` specifies the range of text that the user selects.

The method returns a list of `Either<Command, CodeAction>` objects, representing the possible code actions that can be applied to the document.
A Command is an operation that can be executed by the editor, such as save or inserting text.
A CodeAction is a more complex operation that can have multiple edits.

The method first calls the `codeAction` method from the superclass.
Then, it iterates over the list of `CodeActionStrategy` objects and applies each strategy to the document, context, and range.
Each strategy returns a list of code actions specific to the CD4Analysis language and relevant for the given situation.
The method adds all these code actions to the list returned by the superclass and returns the final list.

### CodeActionStrategy

The CodeActionStrategy interface defines a single method: `apply`.
This method takes the same parameters as the `codeAction` method and returns a list of code actions.
Each subclass of this interface implements a specific kind of code action for the CD4Analysis language, such as extracting a superclass or collapsing the hierarchy.

```java
public interface CodeActionStrategy {
  Optional<Either<Command, CodeAction>> apply(TextDocumentItem document, CodeActionContext context, Range range);
}
```

## Developing New CodeActions

### Working with the AST
A `WorkspaceEdit` is a class representing an edit that can be applied to a document as part of a code action.
The new string for the document is generated by pretty printing the modified AST of the document, using the `AstPrettyPrinter<ASTCDCompilationUnit>` object that is passed to the `CD4AnalysisCodeActionProvider` constructor.
The symbol table or the AST must remain the same when creating this string; otherwise, the file can change unintentionally for the user without the user triggering the action.
Finding and deleting classes in the AST is done with the VisitorPattern as described in [FindClass](visitors/find_class.md) and [DeleteClass](visitors/delete_class.md).
For simplicity, the entire content of a file is always replaced. Otherwise, the formatting becomes too complex.

### Distinguish between File Locations
Two elements necessary for a code action might not be present in the same file.
For example, in the [Pull-Up Field](pull_up_field.md) strategy, the code action might be invoked on a child class, where the parent class is in a different file.
With the `getLocation` method from the `documentManager`, the location can be compared so that in the case of another file, the other AST can be used to find the class needed.

